<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Performance Metrics Dashboard</title>
    <script>
      const GITLAB_PROJECT_ID = 1053;
      const GITLAB_BASE_URL = "https://gitlab.ba.innovatrics.net/";
      const GIT_BRANCH_NAME = "master";
      const GITLAB_TOKEN = "TODO";
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^3"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@^2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@^1"></script>
    <script src="gitlab_api.js" defer></script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
      }
      .chart-container {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        height: 300px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Performance Metrics</h1>
      <div>Last Updated: <span id="lastUpdated"></span></div>
    </div>
    <div id="chartsGrid" class="grid">
    </div>

    <script>
      // Configure and create charts
      function createChart(ctx, stage, data, color) {
        return new Chart(ctx, {
          type: "line",
          data: {
            datasets: [
              {
                label: stage,
                data: data,
                borderColor: color,
                backgroundColor: color + "20",
                tension: 0.2,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,            
            plugins: {
              legend: {
                position: "top",
              },
              title: {
                display: true,
                text: stage,
              },
            },
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "day",
                },
                title: {
                  display: true,
                  text: "Date",
                },
                adapters: {
                  date: {
                    locale: "en",
                  },
                },
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Duration (seconds)",
                },
              },
            },
          },
        });
      }

      // Generate random color
      function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }

      // Call the async function once the DOM is fully loaded
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const stageStats = (await getGitlabPipelineStageStats(
            GITLAB_PROJECT_ID,
            GITLAB_BASE_URL,
            GIT_BRANCH_NAME,
            GITLAB_TOKEN
          ))
          .filter(stage => stage.stage_jobs.some(job => job.duration !== null) && stage.status === "success")
          .sort((a, b) => new Date(a.started_at) - new Date(b.started_at));

          console.log("Pipeline stage statistics:", stageStats);
          
          // Update last updated timestamp
          document.getElementById("lastUpdated").textContent = new Date().toLocaleString();
          
          // Clear existing grid
          const chartsGrid = document.getElementById("chartsGrid");
          chartsGrid.innerHTML = '';
          
          // Create a chart for each stage
          stageStats.forEach((stageData, index) => {
            // Create container for new chart
            const chartContainer = document.createElement("div");
            chartContainer.className = "chart-container";
            const canvas = document.createElement("canvas");
            chartContainer.appendChild(canvas);
            chartsGrid.appendChild(chartContainer);

            // Process data for chart
            const chartData = Object.values(
              stageData.stage_jobs
                .filter(job => job.duration !== null)
                .reduce((acc, job) => {
                  if (!acc[job.pipeline_id]) {
                    acc[job.pipeline_id] = {
                      x: new Date(job.created_at),
                      y: 0
                    };
                  }
                  // Update x to be earliest date
                  if (new Date(job.created_at) < acc[job.pipeline_id].x) {
                    acc[job.pipeline_id].x = new Date(job.created_at);
                  }
                  acc[job.pipeline_id].y += job.duration;
                  return acc;
                }, {})
            );

            // Create chart
            const ctx = canvas.getContext("2d");
            createChart(ctx, stageData.stage, chartData, getRandomColor());
          });

        } catch (error) {
          console.error("Error fetching pipeline stats:", error);
        }
      });
    </script>
  </body>
</html>
